<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel del Owner - Hor G Cargo Express</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(to right, #4CAF50, #B266FF);
  color: #222;
  text-align: center;
  padding: 20px;
}
h2 {
  color: white;
  text-shadow: 1px 1px 3px #333;
}
input, button {
  padding: 10px;
  margin: 5px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}
button {
  background: #4CAF50;
  color: white;
  cursor: pointer;
}
button:hover {
  background: #45a049;
}
table {
  width: 90%;
  margin: 20px auto;
  border-collapse: collapse;
  background: white;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
th {
  background: #B266FF;
  color: white;
  padding: 10px;
}
td {
  padding: 8px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}
</style>
</head>
<body>

<h2>Resumen del Owner (conectado a Google Sheets)</h2>

<div>
  <label>Mes:</label>
  <input type="text" id="mes" placeholder="Ej: Octubre">
  <label>Semana:</label>
  <input type="text" id="semana" placeholder="Ej: 1">
  <label>Driver:</label>
  <input type="text" id="driver" placeholder="Ej: Driver 1">
  <button onclick="filtrarDatos()">Filtrar</button>
  <button onclick="limpiar()">Limpiar</button>
</div>

<table id="tabla"></table>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQJNoOMFPAB8M-UhmKHG1rWxJvHaumF1k012pKyTkUSq2XC5blEQXkNxvAcyfKvayVPjoLjhUGMRA8p/pub?gid=1933431995&single=true&output=csv";
let datos = [];

// Cargar hoja VIAJES
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: function(results) {
    datos = results.data.map(row => {
      const limpio = {};
      for (const key in row) {
        limpio[key.trim().toLowerCase()] = (row[key] || "").toString().trim().toLowerCase();
      }
      return limpio;
    });
    document.getElementById("tabla").innerHTML = "<tr><td colspan='2'>Ingrese filtros y pulse BUSCAR</td></tr>";
  }
});

function filtrarDatos() {
  const mes = document.getElementById("mes").value.trim().toLowerCase();
  const semana = document.getElementById("semana").value.trim().toLowerCase();
  const chofer = document.getElementById("driver").value.trim().toLowerCase();

  // Filtrar viajes por mes, semana y conductor
  const filtrado = datos.filter(r => {
    const m = (r["mes"] || "").trim().toLowerCase();
    const s = (r["semana"] || "").trim().toLowerCase();
    const c = (r["conductor_id"] || "").trim().toLowerCase();
    return (!mes || m === mes) && (!semana || s === semana) && (!chofer || c === chofer);
  });

  if (!filtrado.length) {
    document.getElementById("tabla").innerHTML = "<tr><td colspan='2'>No se encontraron resultados</td></tr>";
    return;
  }

  // Conversión segura a número
  const toNumber = val => parseFloat(val.replace(",", ".").replace(/[^0-9.-]/g, "")) || 0;

  // Cálculos de totales
  const totalIngresos = filtrado.reduce((acc, r) => acc + toNumber(r["ingreso_bruto"]), 0);
  const totalDescuentos = filtrado.reduce((acc, r) => acc + toNumber(r["descuento"]), 0);
  const ingresoNeto = filtrado.reduce((acc, r) => acc + toNumber(r["ingreso_neto"]), 0);
  const totalGastos = filtrado.reduce((acc, r) => acc + toNumber(r["total_gastos"]), 0);
  const pagoDriver = filtrado.reduce((acc, r) => acc + toNumber(r["pago_driver"]), 0);
  const pagoOwner = filtrado.reduce((acc, r) => acc + toNumber(r["pago_owner"]), 0);

  // Mostrar los totales uno debajo del otro
  const tabla = document.getElementById("tabla");
  tabla.innerHTML = `
    <tr><th>Concepto</th><th>Total</th></tr>
    <tr><td>Total Ingresos</td><td>$${totalIngresos.toFixed(2)}</td></tr>
    <tr><td>Total Descuentos</td><td>$${totalDescuentos.toFixed(2)}</td></tr>
    <tr><td>Ingreso Neto</td><td>$${ingresoNeto.toFixed(2)}</td></tr>
    <tr><td>Total Gastos</td><td>$${totalGastos.toFixed(2)}</td></tr>
    <tr><td>Pago a Driver</td><td>$${pagoDriver.toFixed(2)}</td></tr>
    <tr><td>Pago a Owner</td><td>$${pagoOwner.toFixed(2)}</td></tr>
  `;
}

function limpiar() {
  document.getElementById("mes").value = "";
  document.getElementById("semana").value = "";
  document.getElementById("driver").value = "";
  document.getElementById("tabla").innerHTML = "<tr><td colspan='2'>Ingrese filtros y pulse BUSCAR</td></tr>";
}
</script>




</body>
</html>

